/*! @maps4html/web-map-custom-element 06-11-2023 */

class MapExtent extends HTMLElement{static get observedAttributes(){return["units","checked","label","opacity","hidden"]}get units(){return this.getAttribute("units")}set units(t){["OSMTILE","CBMTILE","WGS84","APSTILE"].includes(t)&&this.setAttribute("units",t)}get checked(){return this.hasAttribute("checked")}set checked(t){t?this.setAttribute("checked",""):this.removeAttribute("checked")}get label(){return this.hasAttribute("label")?this.getAttribute("label"):M.options.locale.dfExtent}set label(t){t&&this.setAttribute("label",t)}get opacity(){return+(this._opacity??this.getAttribute("opacity"))}set opacity(t){1<+t||+t<0||this.setAttribute("opacity",t)}get hidden(){return this.hasAttribute("hidden")}set hidden(t){t?this.setAttribute("hidden",""):this.removeAttribute("hidden")}attributeChangedCallback(a,t,r){this.whenReady().then(()=>{switch(a){case"units":break;case"label":t!==r&&(this._layerControlHTML.querySelector(".mapml-layer-item-name").innerHTML=r||M.options.locale.dfExtent);break;case"checked":this._handleChange(),this._calculateBounds(),this._layerControlCheckbox.checked=null!==r;break;case"opacity":t!==r&&(this._opacity=r,this._templatedLayer&&this._templatedLayer.changeOpacity(r));break;case"hidden":if(t!==r){let t=this.parentLayer._propertiesGroupAnatomy;var e=Array.from(this.parentNode.querySelectorAll("map-extent:not([hidden])")).indexOf(this);null!==r?this._layerControlHTML.remove():0===e?t.insertAdjacentElement("afterbegin",this._layerControlHTML):0<e&&this.parentNode.querySelectorAll("map-extent:not([hidden])")[e-1]._layerControlHTML.insertAdjacentElement("afterend",this._layerControlHTML),this._validateLayerControlContainerHidden()}}}).catch(t=>{console.log(t,`
in mapExtent.attributeChangeCallback when changing attribute `+a)})}constructor(){super()}async connectedCallback(){this._createLayerControlExtentHTML=M._createLayerControlExtentHTML.bind(this),this.parentLayer="LAYER-"===this.parentNode.nodeName.toUpperCase()?this.parentNode:this.parentNode.host,this.hasAttribute("data-moving")||this.parentLayer.hasAttribute("data-moving")||(this.querySelector("map-link[rel=query], map-link[rel=features]")&&!this.shadowRoot&&this.attachShadow({mode:"open"}),await this.parentLayer.whenReady(),this.isConnected&&(this._layer=this.parentLayer._layer,this._map=this._layer._map,delete this.parentLayer.bounds,this._templateVars=this._initTemplateVars(this.parentLayer.shadowRoot?this.parentLayer.shadowRoot.querySelector("map-extent > map-meta[name=extent]")||this.parentLayer.shadowRoot.querySelector("map-meta[name=extent]"):this.parentLayer.querySelector("map-extent > map-meta[name=extent]")||this.parentLayer.querySelector("map-meta[name=extent]"),this.units,this._layer._content,this._layer.getBase(),this.units===this._layer.options.mapprojection),this._changeHandler=this._handleChange.bind(this),this.parentLayer.addEventListener("map-change",this._changeHandler),this._opacity=+(this.getAttribute("opacity")||1),this._templatedLayer=M.templatedLayer(this._templateVars,{pane:this._layer._container,opacity:this.opacity,_leafletLayer:this._layer,crs:this._layer._properties.crs,extentZIndex:Array.from(this.parentLayer.querySelectorAll("map-extent")).indexOf(this),extentEl:this._DOMnode||this}),this._layerControlHTML=this._createLayerControlExtentHTML(),this.hidden||this._layer.addExtentToLayerControl(this._layerControlHTML),this._validateLayerControlContainerHidden(),this._templatedLayer._queries&&(this._layer._properties._queries||(this._layer._properties._queries=[]),this._layer._properties._queries=this._layer._properties._queries.concat(this._templatedLayer._queries)),this._calculateBounds()))}getLayerControlHTML(){return this._layerControlHTML}_projectionMatch(){return this.units.toUpperCase()===this._layer.options.mapprojection.toUpperCase()}_validateDisabled(){if(this._templatedLayer){var t=()=>{let t=this._templatedLayer._templates.length,e=0;for(let t=0;t<this._templatedLayer._templates.length;t++)"query"!==this._templatedLayer._templates[t].rel&&(this._templatedLayer._templates[t].layer.isVisible||e++);return e===t};return!this._projectionMatch()||t()?(this.setAttribute("disabled",""),this.disabled=!0):(this.removeAttribute("disabled"),this.disabled=!1),this.toggleLayerControlDisabled(),this.disabled}}toggleLayerControlDisabled(){let t=this._layerControlCheckbox,e=this._layerControlLabel,a=this._opacityControl,r=this._opacitySlider,i=this._selectdetails;this.disabled?(t.disabled=!0,r.disabled=!0,e.style.fontStyle="italic",a.style.fontStyle="italic",i&&i.forEach(t=>{t.querySelectorAll("select").forEach(t=>{t.disabled=!0,t.style.fontStyle="italic"}),t.style.fontStyle="italic"})):(t.disabled=!1,r.disabled=!1,e.style.fontStyle="normal",a.style.fontStyle="normal",i&&i.forEach(t=>{t.querySelectorAll("select").forEach(t=>{t.disabled=!1,t.style.fontStyle="normal"}),t.style.fontStyle="normal"}))}_initTemplateVars(r,i,t,e,a){var s=[],o=this.querySelectorAll("map-link[rel=tile],map-link[rel=image],map-link[rel=features],map-link[rel=query]"),n=new RegExp("(?:{)(.*?)(?:})","g"),l=this.querySelector('map-input[type="zoom" i]'),h=!1,m={zoom:0};if(r){let t=M._metaContentToObject(r.getAttribute("content")),e;m.zoom=t.zoom||m.zoom;let a=Object.keys(t);for(let t=0;t<a.length;t++)if(!a[t].includes("zoom")){e=M.axisToCS(a[t].split("-")[2]);break}var d=M.csToAxes(e);m.bounds=M.boundsToPCRSBounds(L.bounds(L.point(+t["top-left-"+d[0]],+t["top-left-"+d[1]]),L.point(+t["bottom-right-"+d[0]],+t["bottom-right-"+d[1]])),m.zoom,i,e)}else{d=M[i]||M.OSMTILE;m.bounds=d.options.crs.pcrs.bounds}for(var p=0;p<o.length;p++){var u=o[p],c=u.getAttribute("tref");if(u.zoomInput=l,!c){var y,c=M.BLANK_TT_TREF;for(y of t.querySelectorAll("map-input"))c+=`{${y.getAttribute("name")}}`}for(var _=u.hasAttribute("title")?u.getAttribute("title"):"Query this layer",b=c.match(n),A=u.hasAttribute("rel")&&"tile"!==u.getAttribute("rel").toLowerCase()?u.getAttribute("rel").toLowerCase():"tile",g=u.hasAttribute("type")?u.getAttribute("type").toLowerCase():"image/*",x=[],C=u&&u.hasAttribute("tms"),f=t.querySelector("map-meta[name=zoom]")?M._metaContentToObject(t.querySelector("map-meta[name=zoom]").getAttribute("content")):void 0;null!==(S=n.exec(c));){var v,T=S[1],S=this.querySelector("map-input[name="+T+"],map-select[name="+T+"]");if(!S){console.log("input with name="+T+" not found for template variable of same name");break}!S.hasAttribute("type")||"location"!==S.getAttribute("type")||S.hasAttribute("min")&&S.hasAttribute("max")||!S.hasAttribute("axis")||["i","j"].includes(S.getAttribute("axis").toLowerCase())||(l&&c.includes(`{${l.getAttribute("name")}}`)&&l.setAttribute("value",m.zoom),v=S.getAttribute("axis"),T=M.convertPCRSBounds(m.bounds,m.zoom,i,M.axisToCS(v)),S.setAttribute("min",T.min[M.axisToXY(v)]),S.setAttribute("max",T.max[M.axisToXY(v)])),x.push(S),h=h||S.hasAttribute("type")&&"zoom"===S.getAttribute("type").toLowerCase(),"map-select"===S.tagName.toLowerCase()&&((v=document.createElement("div")).insertAdjacentHTML("afterbegin",S.outerHTML),S.htmlselect=v.querySelector("map-select"),S.htmlselect=function(e){var a=document.createElement("select"),r=e.getAttributeNames();for(let t=0;t<r.length;t++)a.setAttribute(r[t],e.getAttribute(r[t]));var i=e.children;for(let e=0;e<i.length;e++){var s=document.createElement("option"),o=i[e].getAttributeNames();for(let t=0;t<o.length;t++)s.setAttribute(o[t],i[e].getAttribute(o[t]));s.innerHTML=i[e].innerHTML,a.appendChild(s)}return a}(S.htmlselect),L.DomEvent.on(S.htmlselect,"change",this.redraw,this),this._userInputs||(this._userInputs=[]),this._userInputs.push(S.htmlselect))}if(c&&b.length===x.length||c===M.BLANK_TT_TREF){"query"===A&&(this._layer.queryable=!0),!h&&l&&x.push(l);let t=l?l.getAttribute("step"):1;t&&"0"!==t&&!isNaN(t)||(t=1),s.push({template:decodeURI(new URL(c,e)),linkEl:u,title:_,rel:A,type:g,values:x,zoomBounds:f,boundsFallbackPCRS:{bounds:m.bounds},projectionMatch:a,projection:this.units||M.FALLBACK_PROJECTION,tms:C,step:t})}}return s}redraw(){this._templatedLayer.redraw()}_handleChange(){this.checked&&this.parentLayer.checked&&!this.disabled?(this._templatedLayer.addTo(this._layer._map),this._templatedLayer.setZIndex(Array.from(this.parentLayer.querySelectorAll("map-extent")).indexOf(this))):this._map.removeLayer(this._templatedLayer)}_validateLayerControlContainerHidden(){let t=this.parentLayer._propertiesGroupAnatomy,e=this.parentLayer.shadowRoot||this.parentLayer;0===e.querySelectorAll("map-extent:not([hidden])").length?t.setAttribute("hidden",""):t.removeAttribute("hidden")}disconnectedCallback(){this.hasAttribute("data-moving")||this.parentLayer.hasAttribute("data-moving")||!this._templatedLayer||(this._validateLayerControlContainerHidden(),this._layerControlHTML.remove(),this._map.removeLayer(this._templatedLayer),this.parentLayer.removeEventListener("map-change",this._changeHandler),delete this._templatedLayer,delete this.parentLayer.bounds)}_calculateBounds(){let e=null,a=0,r=0,i=0,s=0;for(let t=0;t<this._templateVars.length;t++){var o=M._extractInputBounds(this._templateVars[t]);this._templateVars[t].tempExtentBounds=o.bounds,this._templateVars[t].extentZoomBounds=o.zoomBounds,s=e?(e.extend(this._templateVars[t].tempExtentBounds.min),e.extend(this._templateVars[t].tempExtentBounds.max),a=Math.max(a,this._templateVars[t].extentZoomBounds.maxZoom),r=Math.min(r,this._templateVars[t].extentZoomBounds.minZoom),i=Math.max(i,this._templateVars[t].extentZoomBounds.maxNativeZoom),Math.min(s,this._templateVars[t].extentZoomBounds.minNativeZoom)):(e=this._templateVars[t].tempExtentBounds,a=this._templateVars[t].extentZoomBounds.maxZoom,r=this._templateVars[t].extentZoomBounds.minZoom,i=this._templateVars[t].extentZoomBounds.maxNativeZoom,this._templateVars[t].extentZoomBounds.minNativeZoom)}this._templatedLayer.bounds=e,this._templatedLayer.zoomBounds={minZoom:r,maxZoom:a,maxNativeZoom:i,minNativeZoom:s}}whenReady(){return new Promise((e,a)=>{let r,i;this._templatedLayer?e():(r=setInterval(function(t){t._templatedLayer?(clearInterval(r),clearTimeout(i),e()):t.isConnected||(clearInterval(r),clearTimeout(i),a("map-extent was disconnected while waiting to be ready"))},300,this),i=setTimeout(function(){clearInterval(r),clearTimeout(i),a("Timeout reached waiting for extent to be ready")},1e4))})}}export{MapExtent};
//# sourceMappingURL=map-extent.js.map