/*! @maps4html/web-map-custom-element 28-04-2023 */
/* (c) 2023 Open Source Geospatial Foundation - all rights reserved
 * This code is licensed under the GPL 2.0 license, available at the root
 * application directory.
 * Copyright (c) 2023 Canada Centrre for Mapping and Earth Observation, Natural
 * Resources Canada
 * Copyright © 2023 World Wide Web Consortium, (Massachusetts Institute of Technology, 
 * European Research Consortium for Informatics and Mathematics, Keio    
 * University, Beihang). All Rights Reserved. This work is distributed under the 
 * W3C® Software License [1] in the hope that it will be useful, but WITHOUT ANY 
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR 
 * A PARTICULAR PURPOSE.
 * [1] http://www.w3.org/Consortium/Legal/copyright-software
 * 
 */
class MapFeature extends HTMLElement{static get observedAttributes(){return["zoom","onfocus","onclick","onblur"]}get zoom(){return+(this.hasAttribute("zoom")?this.getAttribute("zoom"):0)}set zoom(t){t=parseInt(t,10);!isNaN(t)&&t>=this.min&&t<=this.max&&this.setAttribute("zoom",t)}get min(){return+(this.hasAttribute("min")?this.getAttribute("min"):this._layer._layerEl.extent.zoom.minZoom)}set min(t){t=parseInt(t,10);isNaN(t)||(t>=this._layer._layerEl.extent.zoom.minZoom&&t<=this._layer._layerEl.extent.zoom.maxZoom?this.setAttribute("min",t):this.setAttribute("min",this._layer._layerEl.extent.zoom.minZoom))}get max(){return+(this.hasAttribute("max")?this.getAttribute("max"):this._layer._layerEl.extent.zoom.maxZoom)}set max(t){t=parseInt(t,10);isNaN(t)||(t>=this._layer._layerEl.extent.zoom.minZoom&&t<=this._layer._layerEl.extent.zoom.maxZoom?this.setAttribute("max",t):this.setAttribute("max",this._layer._layerEl.extent.zoom.maxZoom))}get extent(){if(this.isConnected)return this._getFeatureExtent||(this._getFeatureExtent=this._memoizeExtent()),this._getFeatureExtent()}attributeChangedCallback(t,r,e){switch(t){case"zoom":if(r!==e&&this._layer){let t=this._layer,e=t._layerEl,o=t._mapmlvectors;var i;o?._staticFeature&&(this._removeInFeatureList(r),i=this._getNativeZoomAndCS(t._content),o.zoomBounds=o._getZoomBounds(e.shadowRoot||e,i.zoom)),this._removeFeature(),this._updateFeature()}break;case"onfocus":case"onclick":case"onblur":if(this._groupEl){this._groupEl[t]=this[t].bind(this._groupEl);break}}}constructor(){super()}connectedCallback(){this.parentNode.nodeType!==document.DOCUMENT_FRAGMENT_NODE&&"layer-"!==this.parentNode.nodeName.toLowerCase()||this.parentNode.nodeType===document.DOCUMENT_FRAGMENT_NODE&&this.parentNode.host.hasAttribute("data-moving")||"layer-"===this.parentNode.nodeName.toLowerCase()&&this.parentNode.hasAttribute("data-moving")||(this._addFeature(),this._observer=new MutationObserver(t=>{for(var e of t){if("attributes"===e.type&&e.target===this)return;this._removeFeature(),this._updateFeature()}}),this._observer.observe(this,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0}))}disconnectedCallback(){this._layer._layerEl.hasAttribute("data-moving")||(this._removeFeature(),this._observer.disconnect())}_removeFeature(){if(this._groupEl?.isConnected&&this._groupEl.remove(),this._featureGroup?._map){this._featureGroup._map.removeLayer(this._featureGroup);let t=this._layer._mapmlvectors;var e;t&&(t._staticFeature&&(t._features[this.zoom]&&this._removeInFeatureList(this.zoom),e=this._layer.shadowRoot||this._layer._layerEl,t.zoomBounds=t._getZoomBounds(e,this._getNativeZoomAndCS(this._layer._content).zoom)),t.options.properties=null,delete t._layers[this._featureGroup._leaflet_id])}delete this._featureGroup,delete this._groupEl,this._getFeatureExtent&&delete this._getFeatureExtent}_addFeature(){let o="LAYER-"===this.parentNode.nodeName.toUpperCase()||"MAP-EXTENT"===this.parentNode.nodeName.toUpperCase()?this.parentNode:this.parentNode.host;var r=t=>{if(o._layer._map?this._map=this._layer._map:this._layer.once("attached",function(){this._map=this._layer._map},this),this.querySelector("map-geometry"))if(this._layer._mapmlvectors)this._featureGroup?this._setUpEvents():this._updateFeature();else{let t=this._layer._layerEl;this._layer.once("add",this._setUpEvents,this),t.querySelector("map-extent, map-tile")||t.hasAttribute("src")||1!==t.querySelectorAll("map-feature").length||(this._layer._initialize(t),this._layer.fire("extentload"))}};if(o._layer)this._layer=o._layer,r();else{let e="LAYER-"===o.nodeName.toUpperCase()?o:o.parentElement||o.parentNode.host;e.parentNode.addEventListener("createmap",t=>{this._layer=e._layer,r()})}}_updateFeature(){let t=this._layer._mapmlvectors;var e;t&&(e=this._getNativeZoomAndCS(this._layer._content),this._featureGroup=t.addData(this,e.cs,e.zoom),t._layers[this._featureGroup._leaflet_id]=this._featureGroup,this._groupEl=this._featureGroup.options.group,t._staticFeature&&(e=this._layer.shadowRoot||this._layer._layerEl,t.zoomBounds=t._getZoomBounds(e,this._getNativeZoomAndCS(this._layer._content).zoom),t._resetFeatures(),this._map._addZoomLimit(t),L.extend(t.options,t.zoomBounds)),this._setUpEvents())}_setUpEvents(){["click","focus","blur"].forEach(o=>{this["on"+o]&&"function"==typeof this["on"+o]&&(this._groupEl["on"+o]=this["on"+o]),this._groupEl.addEventListener(o,t=>{var e=this["on"+o];this["on"+o]=null,"click"===o?this.dispatchEvent(new PointerEvent(o,{...t})):this.dispatchEvent(new FocusEvent(o,{...t})),this["on"+o]=e})})}_getNativeZoomAndCS(t){let i,s;if(this._extentEl)return this._extentEl.querySelector("map-link[rel=query]")?(i=this._map.getZoom(),s="pcrs"):this._extentEl.querySelector("map-link[rel=features]")&&(i=this._extentEl._nativeZoom,s=this._extentEl._nativeCS),{zoom:i,cs:s};if(t.nodeType===Node.DOCUMENT_NODE)return this._layer._mapmlvectors._getNativeVariables(t);if("LAYER-"===t.nodeName.toUpperCase()){let t=this.parentElement.querySelectorAll("map-meta[name=zoom]"),e=t?.length;i=e?+t[e-1].getAttribute("content")?.split(",").find(t=>t.includes("value"))?.split("=")[1]:0;let o=this.parentElement.querySelectorAll("map-meta[name=cs]"),r=o?.length;return s=r?o[r-1].getAttribute("content"):"pcrs",{zoom:i,cs:s}}}_memoizeExtent(){let h;return function(){if(h&&this._getFeatureExtent)return h;{let i=this._map,t=this.querySelector("map-geometry"),e=this._getNativeZoomAndCS(this._layer._content),o=t.getAttribute("cs")||e.cs,r=this.zoom||e.zoom,s=t.querySelectorAll("map-point, map-linestring, map-polygon, map-multipoint, map-multilinestring"),a=[1/0,1/0,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(var l of s){var p=l.querySelectorAll("map-coordinates");for(let t=0;t<p.length;++t)a=function(t,e,o){var r=e.innerHTML.trim().replace(/<[^>]+>/g,"").replace(/\s+/g," ").split(/[<>\ ]/g);switch(t.tagName){case"MAP-POINT":o=M._updateExtent(o,+r[0],+r[1]);break;case"MAP-LINESTRING":case"MAP-POLYGON":case"MAP-MULTIPOINT":case"MAP-MULTILINESTRING":for(let t=0;t<r.length;t+=2)o=M._updateExtent(o,+r[t],+r[t+1])}return o}(l,p[t],a)}var m=L.point(a[0],a[1]),u=L.point(a[2],a[3]);let n=M.boundsToPCRSBounds(L.bounds(m,u),r,i.options.projection,o);if(1===s.length&&"MAP-POINT"===s[0].tagName.toUpperCase()){let t=i.options.projection,e=this.hasAttribute("max")?+this.getAttribute("max"):M[t].options.resolutions.length-1,o=M[t].options.crs.tile.bounds.getCenter(),r=M[t].transformation.transform(n.min,M[t].scale(+this.zoom||e));n=M.pixelToPCRSBounds(L.bounds(r.subtract(o),r.add(o)),this.zoom||e,t)}u=M._convertAndFormatPCRS(n,i);return h=u}}}_removeInFeatureList(e){let o=this._layer._mapmlvectors;for(let t=0;t<o._features[e].length;++t)if(o._features[e][t]._leaflet_id===this._featureGroup._leaflet_id){o._features[e].splice(t,1);break}}getMaxZoom(){var t=this.extent.topLeft.pcrs,e=this.extent.bottomRight.pcrs,o=L.bounds(L.point(t.horizontal,t.vertical),L.point(e.horizontal,e.vertical)),r=this._map.options.projection,t=this._layer._layerEl.extent.zoom,e=t.minZoom||0,r=t.maxZoom||M[r].options.resolutions.length-1;let i;return this.hasAttribute("zoom")?i=this.zoom:(i=M.getMaxZoom(o,this._map,e,r),this.max<i?i=this.max:this.min>i&&(i=this.min)),i<e?i=e:i>r&&(i=r),i}mapml2geojson(t){t=Object.assign({},{propertyFunction:null,transform:!0},t);let e={type:"Feature",properties:{},geometry:{}},o=this.querySelector("map-properties");o?"function"==typeof t.propertyFunction?e.properties=t.propertyFunction(o):o.querySelector("table")?(a=o.querySelector("table").cloneNode(!0),e.properties=M._table2properties(a)):e.properties={prop0:o.innerHTML.replace(/(<([^>]+)>)/gi,"").replace(/\s/g,"")}:e.properties=null;let r=null,i=null;t.transform&&(r=new proj4.Proj(this._map.options.crs.code),i=new proj4.Proj("EPSG:4326"),"EPSG:3857"!==this._map.options.crs.code&&"EPSG:4326"!==this._map.options.crs.code||(t.transform=!1));var s=this.querySelector("map-geometry").querySelector("map-geometrycollection"),a=this.querySelector("map-geometry").querySelectorAll("map-point, map-polygon, map-linestring, map-multipoint, map-multipolygon, map-multilinestring");if(s){e.geometry.type="GeometryCollection",e.geometry.geometries=[];for(var n of a)e.geometry.geometries.push(M._geometry2geojson(n,r,i,t.transform))}else e.geometry=M._geometry2geojson(a[0],r,i,t.transform);return e}click(t){let e=this._groupEl,o=e.getBoundingClientRect();if(t=t||new MouseEvent("click",{clientX:o.x+o.width/2,clientY:o.y+o.height/2,button:0}),"function"==typeof this.onclick)this.onclick.call(this._groupEl,t);else{var r=this.querySelector("map-properties");if("link"===e.getAttribute("role"))for(var i of e.children)i.mousedown.call(this._featureGroup,t),i.mouseup.call(this._featureGroup,t);if(r&&this.isConnected){let t=this._featureGroup,e=t._layers;for(var s in e)e[s].isPopupOpen()&&e[s].closePopup();t.isPopupOpen()?t.closePopup():t.openPopup()}}}focus(t,e){let o=this._groupEl;"function"==typeof this.onfocus?this.onfocus.call(this._groupEl,t):o.focus(e)}blur(t){"function"==typeof this.onblur?this.onblur.call(this._groupEl,t):document.activeElement.shadowRoot?.activeElement!==this._groupEl&&document.activeElement.shadowRoot?.activeElement.parentNode!==this._groupEl||(this._groupEl.blur(),this._map._container.focus())}zoomTo(){let t=this.extent,e=this._map,o=t.topLeft.pcrs,r=t.bottomRight.pcrs,i=L.bounds(L.point(o.horizontal,o.vertical),L.point(r.horizontal,r.vertical)),s=e.options.crs.unproject(i.getCenter(!0));e.setView(s,this.getMaxZoom(),{animate:!1})}}export{MapFeature};
//# sourceMappingURL=map-feature.js.map