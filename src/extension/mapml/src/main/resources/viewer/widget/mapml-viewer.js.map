{"version":3,"file":"mapml-viewer.js","sources":["../src/mapml-viewer.js"],"sourcesContent":["import './leaflet.js';  // bundled with proj4, proj4leaflet, modularized\nimport './mapml.js';   \nimport { MapLayer } from './layer.js';\n\nexport class MapViewer extends HTMLElement {\n  static get observedAttributes() {\n    return ['lat', 'lon', 'zoom', 'projection', 'width', 'height', 'controls'];\n  }\n  // see comments below regarding attributeChangedCallback vs. getter/setter\n  // usage.  Effectively, the user of the element must use the property, not\n  // the getAttribute/setAttribute/removeAttribute DOM API, because the latter\n  // calls don't result in the getter/setter being called (so you have to use\n  // the getter/setter directly)\n  get controls() {\n    return this.hasAttribute('controls');\n  }\n  set controls(value) {\n    const hasControls = Boolean(value);\n    if (hasControls)\n      this.setAttribute('controls', '');\n    else\n      this.removeAttribute('controls');\n    this._toggleControls(hasControls);\n  }\n  get controlslist() {\n    return this.hasAttribute('controlslist') ? this.getAttribute(\"controlslist\") : \"\";\n  }\n  set controlslist(val) {\n    let options = [\"nofullscreen\", \"nozoom\", \"nolayer\", \"noreload\"],\n        lowerVal = val.toLowerCase();\n    if (this.controlslist.includes(lowerVal) || !options.includes(lowerVal))return;\n    this.setAttribute(\"controlslist\", this.controlslist+` ${lowerVal}`);\n  }\n  get lat() {\n    return this.hasAttribute(\"lat\") ? this.getAttribute(\"lat\") : \"0\";\n  }\n  set lat(val) {\n    if (val) {\n      this.setAttribute(\"lat\", val);\n    }\n  }\n  get lon() {\n    return this.hasAttribute(\"lon\") ? this.getAttribute(\"lon\") : \"0\";\n  }\n  set lon(val) {\n    if (val) {\n      this.setAttribute(\"lon\", val);\n    }\n  }\n  get projection() {\n    return this.hasAttribute(\"projection\") ? this.getAttribute(\"projection\") : \"\";\n  }\n  set projection(val) {\n    if(val && M[val]){\n      this.setAttribute('projection', val);\n      if (this._map && this._map.options.projection !== val){\n        this._map.options.crs = M[val];\n        this._map.options.projection = val;\n        for(let layer of this.querySelectorAll(\"layer-\")){\n          layer.removeAttribute(\"disabled\");\n          let reAttach = this.removeChild(layer);\n          this.appendChild(reAttach);\n        }\n        if(this._debug) for(let i = 0; i<2;i++) this.toggleDebug();\n      } else this.dispatchEvent(new CustomEvent('createmap'));\n    } else throw new Error(\"Undefined Projection\");\n  }\n  get zoom() {\n    return this.hasAttribute(\"zoom\") ? this.getAttribute(\"zoom\") : 0;\n  }\n  set zoom(val) {\n      var parsedVal = parseInt(val,10);\n      if (!isNaN(parsedVal) && (parsedVal >= 0 && parsedVal <= 25)) {\n        this.setAttribute('zoom', parsedVal);\n      }\n  }\n  get layers() {\n    return this.getElementsByTagName('layer-');\n  }\n\n  get extent(){\n    let map = this._map,\n      pcrsBounds = M.pixelToPCRSBounds(\n        map.getPixelBounds(),\n        map.getZoom(),\n        map.options.projection);\n    let formattedExtent = M.convertAndFormatPCRS(pcrsBounds, map);\n    if(map.getMaxZoom() !== Infinity){\n      formattedExtent.zoom = {\n        minZoom:map.getMinZoom(),\n        maxZoom:map.getMaxZoom()\n      };\n    }\n    return (formattedExtent);\n  }\n\n  constructor() {\n    // Always call super first in constructor\n    super();\n    this._source = this.outerHTML;\n    let tmpl = document.createElement('template');\n    tmpl.innerHTML = `<link rel=\"stylesheet\" href=\"${new URL(\"mapml.css\", import.meta.url).href}\">`; // jshint ignore:line\n    \n    let shadowRoot = this.attachShadow({mode: 'open'});\n    this._container = document.createElement('div');\n\n    let output = \"<output role='status' aria-live='polite' aria-atomic='true' class='mapml-screen-reader-output'></output>\";\n    this._container.insertAdjacentHTML(\"beforeend\", output);\n\n    // Set default styles for the map element.\n    let mapDefaultCSS = document.createElement('style');\n    mapDefaultCSS.innerHTML =\n    `:host {` +\n    `all: initial;` + // Reset properties inheritable from html/body, as some inherited styles may cause unexpected issues with the map element's components (https://github.com/Maps4HTML/Web-Map-Custom-Element/issues/140).\n    `contain: layout size;` + // Contain layout and size calculations within the map element.\n    `display: inline-block;` + // This together with dimension properties is required so that Leaflet isn't working with a height=0 box by default.\n    `height: 150px;` + // Provide a \"default object size\" (https://github.com/Maps4HTML/HTML-Map-Element/issues/31).\n    `width: 300px;` +\n    `border-width: 2px;` + // Set a default border for contrast, similar to UA default for iframes.\n    `border-style: inset;` +\n    `}` +\n    `:host([frameborder=\"0\"]) {` +\n    `border-width: 0;` +\n    `}` +\n    `:host([hidden]) {` +\n    `display: none!important;` +\n    `}` +\n    `:host .leaflet-control-container {` +\n    `visibility: hidden!important;` + // Visibility hack to improve percieved performance (mitigate FOUC) â€“ visibility is unset in mapml.css! (https://github.com/Maps4HTML/Web-Map-Custom-Element/issues/154).\n    `}`;\n    \n    // Hide all (light DOM) children of the map element.\n    let hideElementsCSS = document.createElement('style');\n    hideElementsCSS.innerHTML =\n    `mapml-viewer > * {` +\n    `display: none!important;` +\n    `}`;\n\n    shadowRoot.appendChild(mapDefaultCSS);\n    shadowRoot.appendChild(tmpl.content.cloneNode(true));\n    shadowRoot.appendChild(this._container);\n\n    this.appendChild(hideElementsCSS);\n\n    this._toggleState = false;\n    this.controlsListObserver = new MutationObserver((m) => {\n      m.forEach((change)=>{\n        if(change.type===\"attributes\" && change.attributeName === \"controlslist\")\n          this.setControls(false,false,false);\n      });\n    });\n    this.controlsListObserver.observe(this, {attributes:true});\n  }\n  connectedCallback() {\n    if (this.isConnected) {\n\n      // the dimension attributes win, if they're there. A map does not\n      // have an intrinsic size, unlike an image or video, and so must\n      // have a defined width and height.\n      var s = window.getComputedStyle(this),\n        wpx = s.width, hpx=s.height,\n        w = parseInt(wpx.replace('px','')),\n        h = parseInt(hpx.replace('px',''));\n\n      if (wpx === \"\" || hpx === \"\") {\n         return;\n      }\n\n      if (!this.width || this.width !== w) {\n        this._container.style.width = wpx;\n        this.width = w;\n      } else {\n        this._container.style.width = this.width+\"px\";\n      }\n\n      if (!this.height || this.height !== h) {\n        this._container.style.height = hpx;\n        this.height = h;\n      } else {\n        this._container.style.height = this.height+\"px\";\n      }\n\n      // create an array to track the history of the map and the current index\n      if(!this._history){\n        this._history = [];\n        this._historyIndex = -1;\n        this._traversalCall = false;\n      }\n\n      // wait for createmap event before creating leaflet map\n      // this allows a safeguard for the case where loading a custom TCRS takes longer than loading mapml-viewer.js/web-map.js\n      this.addEventListener('createmap', ()=>{\n        if (!this._map) {\n          this._map = L.map(this._container, {\n            center: new L.LatLng(this.lat, this.lon),\n            projection: this.projection,\n            query: true,\n            contextMenu: true,\n            announceMovement: M.options.announceMovement,\n            featureIndex: true,\n            mapEl: this,\n            crs: M[this.projection],\n            zoom: this.zoom,\n            zoomControl: false,\n            // because the M.MapMLLayer invokes _tileLayer._onMoveEnd when\n            // the mapml response is received the screen tends to flash.  I'm sure\n            // there is a better configuration than that, but at this moment\n            // I'm not sure how to approach that issue.\n            // See https://github.com/Maps4HTML/MapML-Leaflet-Client/issues/24\n            fadeAnimation: true\n          });\n          this._addToHistory();\n          // the attribution control is not optional\n          M.attributionControl(this);\n\n          this.setControls(false,false,true);\n          this._crosshair = M.crosshair().addTo(this._map);\n          if(M.options.featureIndexOverlayOption) this._featureIndexOverlay = M.featureIndexOverlay().addTo(this._map);\n          // https://github.com/Maps4HTML/Web-Map-Custom-Element/issues/274\n          this.setAttribute('role', 'application');\n          // Make the Leaflet container element programmatically identifiable\n          // (https://github.com/Leaflet/Leaflet/issues/7193).\n          this._container.setAttribute('role', 'region');\n          this._container.setAttribute('aria-label', 'Interactive map');\n    \n          this._setUpEvents();\n          // this.fire('load', {target: this});\n        }\n      }, {once:true});\n \n      let custom = !([\"CBMTILE\",\"APSTILE\",\"OSMTILE\",\"WGS84\"].includes(this.projection));\n      // if the page doesn't use nav.js or isn't custom then dispatch createmap event\t\n      if(!custom){\t\n        this.dispatchEvent(new CustomEvent('createmap'));\n      }\n    }\n  }\n  disconnectedCallback() {\n    //this._removeEvents();\n    delete this._map;\n  }\n  adoptedCallback() {\n//    console.log('Custom map element moved to new page.');\n  }\n\n  setControls(isToggle, toggleShow, setup){\n    if (this.controls && this._map) {\n      let controls = [\"_zoomControl\", \"_reloadButton\", \"_fullScreenControl\", \"_layerControl\"],\n          options = [\"nozoom\", \"noreload\", \"nofullscreen\", 'nolayer'],\n          mapSize = this._map.getSize().y,\n          totalSize = 0;\n\n      //removes the left hand controls, if not done they will be re-added in the incorrect order\n      //better to just reset them\n      for(let i = 0 ; i<3;i++){\n        if(this[controls[i]]){\n          this._map.removeControl(this[controls[i]]);\n          delete this[controls[i]];\n        }\n      }\n\n      if (!this.controlslist.toLowerCase().includes(\"nolayer\") && !this._layerControl && this.layers.length > 0){\n        this._layerControl = M.mapMlLayerControl(null,{\"collapsed\": true, mapEl: this}).addTo(this._map);\n        //if this is the initial setup the layers dont need to be readded, causes issues if they are\n        if(!setup){\n          for (var i=0;i<this.layers.length;i++) {\n            if (!this.layers[i].hidden) {\n              this._layerControl.addOverlay(this.layers[i]._layer, this.layers[i].label);\n              this._map.on('moveend', this.layers[i]._validateDisabled,  this.layers[i]);\n              this.layers[i]._layerControl = this._layerControl;\n            }\n          }\n          this._map.fire(\"validate\");\n        }\n      }\n      if (!this.controlslist.toLowerCase().includes(\"nozoom\") && !this._zoomControl && (totalSize + 93) <= mapSize){\n        totalSize += 93;\n        this._zoomControl = L.control.zoom().addTo(this._map);\n      }\n      if (!this.controlslist.toLowerCase().includes(\"noreload\") && !this._reloadButton && (totalSize + 49) <= mapSize){\n        totalSize += 49;\n        this._reloadButton = M.reloadButton().addTo(this._map);\n      }\n      if (!this.controlslist.toLowerCase().includes(\"nofullscreen\") && !this._fullScreenControl && (totalSize + 49) <= mapSize){\n        totalSize += 49;\n        this._fullScreenControl = M.fullscreenButton().addTo(this._map);\n      }\n      //removes any control layers that are not needed, either by the toggling or by the controlslist attribute\n      for(let i in options){\n        if(this[controls[i]] && (this.controlslist.toLowerCase().includes(options[i]) || (isToggle && !toggleShow ))){\n          this._map.removeControl(this[controls[i]]);\n          delete this[controls[i]];\n        }\n      }\n    }\n  }\n  attributeChangedCallback(name, oldValue, newValue) {\n//    console.log('Attribute: ' + name + ' changed from: '+ oldValue + ' to: '+newValue);\n    // \"Best practice\": handle side-effects in this callback\n    // https://developers.google.com/web/fundamentals/web-components/best-practices\n    // https://developers.google.com/web/fundamentals/web-components/best-practices#avoid-reentrancy\n    // note that the example is misleading, since the user can't use\n    // setAttribute or removeAttribute to set the property, they need to use\n    // the property directly in their API usage, which kinda sucks\n    /*\n  const hasValue = newValue !== null;\n  switch (name) {\n    case 'checked':\n      // Note the attributeChangedCallback is only handling the *side effects*\n      // of setting the attribute.\n      this.setAttribute('aria-checked', hasValue);\n      break;\n    ...\n  }     */\n  }\n  _dropHandler(event) {\n    event.preventDefault();\n    let text = event.dataTransfer.getData(\"text\");\n    try {\n      new URL(text);\n      // create a new <layer-> child of this <mapml-viewer> element\n      let l = new MapLayer();\n      l.src = event.dataTransfer.getData(\"text\");\n      l.label = 'Layer';\n      l.checked = 'true';\n      this.appendChild(l);\n      l.addEventListener(\"error\", function () {\n        if (l.parentElement) {\n          // should invoke lifecyle callbacks automatically by removing it from DOM\n          l.parentElement.removeChild(l);\n        }\n        // garbage collect it\n        l = null;\n      });\n    } catch (err) {\n      text = text.replace(/(<!--.*?-->)|(<!--[\\S\\s]+?-->)|(<!--[\\S\\s]*?$)/g, '').trim();\n      if ((text.slice(0,7) === \"<layer-\") && (text.slice(-9) === \"</layer->\")) {\n        this.insertAdjacentHTML(\"beforeend\", text);\n      } else {\n        try {\n          this.geojson2mapml(JSON.parse(text));\n        } catch {\n          console.log(\"Invalid Input!\");\n        }}\n    }\n  }\n  _dragoverHandler(event) {\n    event.preventDefault();\n    event.dataTransfer.dropEffect = \"copy\";\n  }\n  _removeEvents() {\n    if (this._map) {\n      this._map.off('preclick click dblclick mousemove mouseover mouseout mousedown mouseup contextmenu', false, this);\n      this._map.off('load movestart move moveend zoomstart zoom zoomend', false, this);\n      this.removeEventListener(\"drop\", this._dropHandler, false);\n      this.removeEventListener(\"dragover\", this._dragoverHandler, false);\n    }\n  }\n  _setUpEvents() {\n    this.addEventListener(\"drop\", this._dropHandler, false);\n    this.addEventListener(\"dragover\", this._dragoverHandler, false);\n    this.addEventListener(\"change\",\n    function(e) {\n      if(e.target.tagName === \"LAYER-\"){\n        this.dispatchEvent(new CustomEvent(\"layerchange\", {details:{target: this, originalEvent: e}}));\n      }\n    }, false);\n\n    this.parentElement.addEventListener('keyup', function (e) {\n      if(e.keyCode === 9 && document.activeElement.nodeName === \"MAPML-VIEWER\"){\n        document.activeElement.dispatchEvent(new CustomEvent('mapfocused', {detail:\n              {target: this}}));\n      }\n    });\n    // pasting layer- and geojson using Ctrl+V \n    this.parentElement.addEventListener('keydown', function (e) {\n      if(e.keyCode === 86 && e.ctrlKey && document.activeElement.nodeName === \"MAPML-VIEWER\"){\n        navigator.clipboard\n          .readText()\n          .then(\n            (layer) => {\n              layer = layer.replace(/(<!--.*?-->)|(<!--[\\S\\s]+?-->)|(<!--[\\S\\s]*?$)/g, '').trim();\n              if ((layer.slice(0,7) === \"<layer-\") && (layer.slice(-9) === \"</layer->\")) {\n                document.activeElement.insertAdjacentHTML(\"beforeend\", layer);\n              } else {\n                try {\n                  document.activeElement.geojson2mapml(JSON.parse(layer));\n                } catch {\n                  console.log(\"Invalid Paste!\");\n                }}});\n      }\n    });\n    this.parentElement.addEventListener('mousedown', function (e) {\n      if(document.activeElement.nodeName === \"MAPML-VIEWER\"){\n        document.activeElement.dispatchEvent(new CustomEvent('mapfocused', {detail:\n              {target: this}}));\n      }\n    });\n    this._map.on('load',\n      function () {\n        this.dispatchEvent(new CustomEvent('load', {detail: {target: this}}));\n      }, this);\n    this._map.on('preclick',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('preclick', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('click',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('click', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('dblclick',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('dblclick', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('mousemove',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('mousemove', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('mouseover',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('mouseover', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('mouseout',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('mouseout', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('mousedown',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('mousedown', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      },this);\n    this._map.on('mouseup',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('mouseup', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('contextmenu',\n      function (e) {\n        this.dispatchEvent(new CustomEvent('contextmenu', {detail:\n          {lat: e.latlng.lat,     lon: e.latlng.lng,\n             x: e.containerPoint.x, y: e.containerPoint.y}\n         }));\n      }, this);\n    this._map.on('movestart',\n      function () {\n        this._updateMapCenter();\n        this.dispatchEvent(new CustomEvent('movestart', {detail:\n          {target: this}}));\n      }, this);\n    this._map.on('move',\n      function () {\n        this._updateMapCenter();\n        this.dispatchEvent(new CustomEvent('move', {detail:\n          {target: this}}));\n      }, this);\n    this._map.on('moveend',\n      function () {\n        this._updateMapCenter();\n        this._addToHistory();\n        this.dispatchEvent(new CustomEvent('moveend', {detail:\n          {target: this}}));\n      }, this);\n    this._map.on('zoomstart',\n      function () {\n        this._updateMapCenter();\n        this.dispatchEvent(new CustomEvent('zoomstart', {detail:\n          {target: this}}));\n      }, this);\n    this._map.on('zoom',\n      function () {\n        this._updateMapCenter();\n        this.dispatchEvent(new CustomEvent('zoom', {detail:\n          {target: this}}));\n      }, this);\n    this._map.on('zoomend',\n      function () {\n        this._updateMapCenter();\n        this.dispatchEvent(new CustomEvent('zoomend', {detail:\n          {target: this}}));\n      }, this);\n  }\n  _toggleControls() {\n    if (this._map) {\n      this.setControls(true, this._toggleState, false);\n      this._toggleState = !this._toggleState;\n    }\n  }\n\n  toggleDebug(){\n    if(this._debug){\n      this._debug.remove();\n      this._debug = undefined;\n    } else {\n      this._debug = M.debugOverlay().addTo(this._map);\n    }\n  }\n  \n  _widthChanged(width) {\n    this.style.width = width+\"px\";\n    this._container.style.width = width+\"px\";\n    if (this._map) {\n        this._map.invalidateSize(false);\n    }\n  }\n  _heightChanged(height) {\n    this.style.height = height+\"px\";\n    this._container.style.height = height+\"px\";\n    if (this._map) {\n        this._map.invalidateSize(false);\n    }\n  }\n  zoomTo(lat, lon, zoom) {\n    zoom = Number.isInteger(+zoom) ? +zoom : this.zoom;\n    let location = new L.LatLng(+lat, +lon);\n    this._map.setView(location, zoom);\n    this.zoom = zoom;\n    this.lat = location.lat;\n    this.lon = location.lng;\n  }\n  _updateMapCenter() {\n    // remember to tell Leaflet event handler that 'this' in here refers to\n    //  something other than the map in this case the custom polymer element\n    this.lat = this._map.getCenter().lat;\n    this.lon = this._map.getCenter().lng;\n    this.zoom = this._map.getZoom();\n  }\n\n  /**\n   * Adds to the maps history on moveends\n   * @private\n   */\n  _addToHistory(){\n    if(this._traversalCall > 0) { // this._traversalCall tracks how many consecutive moveends to ignore from history\n      this._traversalCall--;      // this is useful for ignoring moveends corresponding to back, forward and reload\n      return;\n    }\n\n    let mapLocation = this._map.getPixelBounds().getCenter();\n    let location = {\n      zoom: this._map.getZoom(),\n      x:mapLocation.x,\n      y:mapLocation.y,\n    };\n    this._historyIndex++;\n    this._history.splice(this._historyIndex, 0, location);\n  }\n\n  /**\n   * Allow user to move back in history\n   */\n  back(){\n    let history = this._history;\n    let curr = history[this._historyIndex];\n\n    if(this._historyIndex > 0){\n      this._historyIndex--;\n      let prev = history[this._historyIndex];\n\n      if(prev.zoom !== curr.zoom){\n        this._traversalCall = 2;  // allows the next 2 moveends to be ignored from history\n\n        let currScale = this._map.options.crs.scale(curr.zoom); // gets the scale of the current zoom level\n        let prevScale = this._map.options.crs.scale(prev.zoom); // gets the scale of the previous zoom level\n\n        let scale = currScale / prevScale; // used to convert the previous pixel location to be in terms of the current zoom level\n\n        this._map.panBy([((prev.x * scale) - curr.x), ((prev.y * scale) - curr.y)], {animate: false});\n        this._map.setZoom(prev.zoom);\n      } else {\n        this._traversalCall = 1;\n        this._map.panBy([(prev.x - curr.x), (prev.y - curr.y)]);\n      }\n    }\n  }\n\n  /**\n   * Allows user to move forward in history\n   */\n  forward(){\n    let history = this._history;\n    let curr = history[this._historyIndex];\n    if(this._historyIndex < history.length - 1){\n      this._historyIndex++;\n      let next = history[this._historyIndex];\n\n      if(next.zoom !== curr.zoom){\n        this._traversalCall = 2; // allows the next 2 moveends to be ignored from history\n\n        let currScale = this._map.options.crs.scale(curr.zoom); // gets the scale of the current zoom level\n        let nextScale = this._map.options.crs.scale(next.zoom); // gets the scale of the next zoom level\n\n        let scale = currScale / nextScale; // used to convert the next pixel location to be in terms of the current zoom level\n\n        this._map.panBy([((next.x * scale) - curr.x), ((next.y * scale) - curr.y)], {animate: false});\n        this._map.setZoom(next.zoom);\n      } else {\n        this._traversalCall = 1;\n        this._map.panBy([(next.x - curr.x), (next.y - curr.y)]);\n      }\n    }\n  }\n\n  /**\n   * Allows the user to reload/reset the map's location to it's initial location\n   */\n  reload(){\n    let initialLocation = this._history.shift();\n    let mapLocation = this._map.getPixelBounds().getCenter();\n    let curr = {\n      zoom: this._map.getZoom(),\n      x:mapLocation.x,\n      y:mapLocation.y,\n    };\n\n    this._history = [initialLocation];\n    this._historyIndex = 0;\n\n    if(initialLocation.zoom !== curr.zoom) {\n      this._traversalCall = 2; // ignores the next 2 moveend events\n\n      let currScale = this._map.options.crs.scale(curr.zoom); // gets the scale of the current zoom level\n      let initScale = this._map.options.crs.scale(initialLocation.zoom); // gets the scale of the initial location's zoom\n\n      let scale = currScale / initScale;\n\n      this._map.panBy([((initialLocation.x * scale) - curr.x), ((initialLocation.y * scale) - curr.y)], {animate: false});\n      this._map.setZoom(initialLocation.zoom);\n    } else { // if it's on the same zoom level as the initial location, no need to calculate scales\n      this._traversalCall = 1;\n      this._map.panBy([(initialLocation.x- curr.x), (initialLocation.y - curr.y)]);\n    }\n  }\n\n  viewSource(){\n    let blob = new Blob([this._source],{type:\"text/plain\"}),\n        url = URL.createObjectURL(blob);\n    window.open(url);\n    URL.revokeObjectURL(url);\n  }\n\n  defineCustomProjection(jsonTemplate) {\n    let t = JSON.parse(jsonTemplate);\n    if (t === undefined || !t.proj4string || !t.projection || !t.resolutions || !t.origin || !t.bounds) throw new Error('Incomplete TCRS Definition');\n    if (t.projection.indexOf(\":\") >= 0) throw new Error('\":\" is not permitted in projection name');\n    if (M[t.projection.toUpperCase()]) return t.projection.toUpperCase();\n    let tileSize = [256, 512, 1024, 2048, 4096].includes(t.tilesize)?t.tilesize:256;\n\n    M[t.projection] = new L.Proj.CRS(t.projection, t.proj4string, {\n      origin: t.origin,\n      resolutions: t.resolutions,\n      bounds: L.bounds(t.bounds),\n      crs: {\n        tcrs: {\n          horizontal: {\n            name: \"x\",\n            min: 0, \n            max: zoom => (M[t.projection].options.bounds.getSize().x / M[t.projection].options.resolutions[zoom]).toFixed()\n          },\n          vertical: {\n            name: \"y\",\n            min:0, \n            max: zoom => (M[t.projection].options.bounds.getSize().y / M[t.projection].options.resolutions[zoom]).toFixed()\n          },\n          bounds: zoom => L.bounds([M[t.projection].options.crs.tcrs.horizontal.min,\n            M[t.projection].options.crs.tcrs.vertical.min],\n            [M[t.projection].options.crs.tcrs.horizontal.max(zoom),\n            M[t.projection].options.crs.tcrs.vertical.max(zoom)])\n        },\n        pcrs: {\n          horizontal: {\n            name: \"easting\",\n            get min() {return M[t.projection].options.bounds.min.x;},\n            get max() {return M[t.projection].options.bounds.max.x;}\n          }, \n          vertical: {\n            name: \"northing\", \n            get min() {return M[t.projection].options.bounds.min.y;},\n            get max() {return M[t.projection].options.bounds.max.y;}\n          },\n          get bounds() {return M[t.projection].options.bounds;}\n        }, \n        gcrs: {\n          horizontal: {\n            name: \"longitude\",\n            // set min/max axis values from EPSG registry area of use, retrieved 2019-07-25\n            get min() {return M[t.projection].unproject(M.OSMTILE.options.bounds.min).lng;},\n            get max() {return M[t.projection].unproject(M.OSMTILE.options.bounds.max).lng;}\n          }, \n          vertical: {\n            name: \"latitude\",\n            // set min/max axis values from EPSG registry area of use, retrieved 2019-07-25\n            get min() {return M[t.projection].unproject(M.OSMTILE.options.bounds.min).lat;},\n            get max() {return M[t.projection].unproject(M.OSMTILE.options.bounds.max).lat;}\n          },\n          get bounds() {return L.latLngBounds(\n                [M[t.projection].options.crs.gcrs.vertical.min,M[t.projection].options.crs.gcrs.horizontal.min],\n                [M[t.projection].options.crs.gcrs.vertical.max,M[t.projection].options.crs.gcrs.horizontal.max]);}\n        },\n        map: {\n          horizontal: {\n            name: \"i\",\n            min: 0,\n            max: map => map.getSize().x\n          },\n          vertical: {\n            name: \"j\",\n            min: 0,\n            max: map => map.getSize().y\n          },\n          bounds: map => L.bounds(L.point([0,0]),map.getSize())\n        },\n        tile: {\n          horizontal: {\n            name: \"i\",\n            min: 0,\n            max: tileSize,\n          },\n          vertical: {\n            name: \"j\",\n            min: 0,\n            max: tileSize,\n          },\n          get bounds() {return L.bounds(\n                    [M[t.projection].options.crs.tile.horizontal.min,M[t.projection].options.crs.tile.vertical.min],\n                    [M[t.projection].options.crs.tile.horizontal.max,M[t.projection].options.crs.tile.vertical.max]);}\n        },\n        tilematrix: {\n          horizontal: {\n            name: \"column\",\n            min: 0,\n            max: zoom => (M[t.projection].options.crs.tcrs.horizontal.max(zoom) / M[t.projection].options.crs.tile.bounds.getSize().x).toFixed()\n          },\n          vertical: {\n            name: \"row\",\n            min: 0,\n            max: zoom => (M[t.projection].options.crs.tcrs.vertical.max(zoom) / M[t.projection].options.crs.tile.bounds.getSize().y).toFixed()\n          },\n          bounds: zoom => L.bounds(\n                   [M[t.projection].options.crs.tilematrix.horizontal.min,\n                   M[t.projection].options.crs.tilematrix.vertical.min],\n                   [M[t.projection].options.crs.tilematrix.horizontal.max(zoom),\n                   M[t.projection].options.crs.tilematrix.vertical.max(zoom)])\n        }\n      },\n    });      //creates crs using L.Proj\n    M[t.projection.toUpperCase()] = M[t.projection]; //adds the projection uppercase to global M\n    return t.projection;\n  }\n\n  geojson2mapml(json, options = {}){\n    if (options.projection === undefined) {\n      options.projection = this.projection;\n    }\n    let geojsonLayer = M.geojson2mapml(json, options);\n    this.appendChild(geojsonLayer);\n    return geojsonLayer;\n  }\n}\n// need to provide options { extends: ... }  for custom built-in elements\nwindow.customElements.define('mapml-viewer', MapViewer);\nwindow.customElements.define('layer-', MapLayer);\n"],"names":["MapLayer","MapViewer","HTMLElement","observedAttributes","controls","this","hasAttribute","value","hasControls","Boolean","setAttribute","removeAttribute","_toggleControls","controlslist","getAttribute","val","lowerVal","toLowerCase","includes","lat","lon","projection","M","Error","_map","options","crs","let","layer","querySelectorAll","reAttach","removeChild","appendChild","_debug","i","toggleDebug","dispatchEvent","CustomEvent","zoom","parsedVal","parseInt","isNaN","layers","getElementsByTagName","extent","map","pcrsBounds","pixelToPCRSBounds","getPixelBounds","getZoom","formattedExtent","convertAndFormatPCRS","getMaxZoom","Infinity","minZoom","getMinZoom","maxZoom","constructor","super","_source","outerHTML","tmpl","document","createElement","innerHTML","URL","import","meta","url","href","shadowRoot","attachShadow","mode","_container","insertAdjacentHTML","mapDefaultCSS","hideElementsCSS","content","cloneNode","_toggleState","controlsListObserver","MutationObserver","m","forEach","change","type","attributeName","setControls","observe","attributes","connectedCallback","wpx","hpx","w","h","isConnected","s","window","getComputedStyle","width","height","replace","style","_history","_historyIndex","_traversalCall","addEventListener","L","center","LatLng","query","contextMenu","announceMovement","featureIndex","mapEl","zoomControl","fadeAnimation","_addToHistory","attributionControl","_crosshair","crosshair","addTo","featureIndexOverlayOption","_featureIndexOverlay","featureIndexOverlay","_setUpEvents","once","disconnectedCallback","adoptedCallback","isToggle","toggleShow","setup","mapSize","getSize","y","totalSize","removeControl","_layerControl","length","mapMlLayerControl","collapsed","hidden","addOverlay","_layer","label","on","_validateDisabled","fire","_zoomControl","control","_reloadButton","reloadButton","_fullScreenControl","fullscreenButton","attributeChangedCallback","name","oldValue","newValue","_dropHandler","event","preventDefault","text","dataTransfer","getData","l","src","checked","parentElement","err","trim","slice","geojson2mapml","JSON","parse","console","log","_dragoverHandler","dropEffect","_removeEvents","off","removeEventListener","e","target","tagName","details","originalEvent","keyCode","activeElement","nodeName","detail","ctrlKey","navigator","clipboard","readText","then","latlng","lng","x","containerPoint","_updateMapCenter","remove","undefined","debugOverlay","_widthChanged","invalidateSize","_heightChanged","zoomTo","Number","isInteger","location","setView","getCenter","mapLocation","splice","back","prev","history","curr","scale","panBy","animate","setZoom","forward","next","reload","initialLocation","shift","viewSource","blob","Blob","createObjectURL","open","revokeObjectURL","defineCustomProjection","jsonTemplate","t","proj4string","resolutions","origin","bounds","indexOf","toUpperCase","tileSize","tilesize","Proj","CRS","tcrs","horizontal","min","max","toFixed","vertical","pcrs","gcrs","unproject","OSMTILE","latLngBounds","point","tile","tilematrix","json","geojsonLayer","customElements","define"],"mappings":"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"}